name: CI and Release

on:
  pull_request:
  merge_group:
    types: [checks_requested]
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  ci:
    name: fmt + lint + tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install Arch dependencies
        run: |
          pacman -Syu --noconfirm \
            git \
            gcc \
            pkgconf \
            fontconfig \
            freetype2 \
            wayland \
            libxkbcommon \
            gstreamer \
            gst-plugins-base \
            gst-plugins-good \
            gst-plugins-bad \
            gst-libav

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run CI suite (xtask)
        run: cargo ci

  package:
    name: Build artifact
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    needs: ci
    outputs:
      crate_version: ${{ steps.version.outputs.crate_version }}
      release_tag: ${{ steps.version.outputs.release_tag }}
    steps:
      - name: Install Arch dependencies
        run: |
          pacman -Syu --noconfirm \
            git \
            gcc \
            pkgconf \
            fontconfig \
            freetype2 \
            wayland \
            libxkbcommon \
            gstreamer \
            gst-plugins-base \
            gst-plugins-good \
            gst-plugins-bad \
            gst-libav

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Read crate version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          manifest_path="crates/waybg-cli/Cargo.toml"
          crate_version="$(sed -nE 's/^version = "([^"]+)"/\1/p' "${manifest_path}" | head -n1)"
          if [[ -z "${crate_version}" ]]; then
            echo "Failed to parse version from ${manifest_path}" >&2
            exit 1
          fi
          echo "crate_version=${crate_version}" >> "${GITHUB_OUTPUT}"
          echo "release_tag=v${crate_version}" >> "${GITHUB_OUTPUT}"

      - name: Build release binary
        run: cargo build --release --locked -p waybg-cli --bin waybg

      - name: Create Linux ELF artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          artifact_name="waybg-${{ steps.version.outputs.crate_version }}-archlinux-x86_64-elf"
          cp target/release/waybg "dist/${artifact_name}"
          chmod +x "dist/${artifact_name}"
          sha256sum "dist/${artifact_name}" > dist/SHA256SUMS.txt

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: waybg-archlinux-x86_64-${{ github.sha }}
          path: dist/*
          if-no-files-found: error

  version_gate:
    name: Detect version change
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: package
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
      previous_version: ${{ steps.detect.outputs.previous_version }}
      current_version: ${{ steps.detect.outputs.current_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Cargo.toml version change
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          manifest_path="crates/waybg-cli/Cargo.toml"
          current_version="$(sed -nE 's/^version = "([^"]+)"/\1/p' "${manifest_path}" | head -n1)"
          previous_version=""
          changed="false"

          before_sha="${{ github.event.before }}"
          if [[ "${before_sha}" != "0000000000000000000000000000000000000000" ]]; then
            if git cat-file -e "${before_sha}:${manifest_path}" 2>/dev/null; then
              previous_version="$(git show "${before_sha}:${manifest_path}" | sed -nE 's/^version = "([^"]+)"/\1/p' | head -n1)"
            fi
          fi

          if [[ -n "${current_version}" && "${current_version}" != "${previous_version}" ]]; then
            changed="true"
          fi

          echo "previous_version=${previous_version}" >> "${GITHUB_OUTPUT}"
          echo "current_version=${current_version}" >> "${GITHUB_OUTPUT}"
          echo "changed=${changed}" >> "${GITHUB_OUTPUT}"

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [package, version_gate]
    if: github.event_name == 'push' && needs.version_gate.outputs.changed == 'true'
    permissions:
      contents: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: waybg-archlinux-x86_64-${{ github.sha }}
          path: dist

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.package.outputs.release_tag }}
          name: ${{ needs.package.outputs.release_tag }}
          files: |
            dist/*-archlinux-x86_64-elf
            dist/SHA256SUMS.txt
          generate_release_notes: true
          overwrite_files: true
