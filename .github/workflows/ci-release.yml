name: CI and Release

on:
  pull_request:
  merge_group:
    types: [checks_requested]
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

env:
  ZIG_VERSION: 0.15.2

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: fmt + build + tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libasound2-dev \
            libgl1-mesa-dev \
            libwayland-dev \
            libx11-dev \
            libxcursor-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxinerama-dev \
            libxkbcommon-dev \
            libxrender-dev \
            libxrandr-dev

      - name: Run CI checks
        run: zig build ci

  package:
    name: Build artifact
    runs-on: ubuntu-latest
    needs: ci
    outputs:
      package_version: ${{ steps.version.outputs.package_version }}
      release_tag: ${{ steps.version.outputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libasound2-dev \
            libgl1-mesa-dev \
            libwayland-dev \
            libx11-dev \
            libxcursor-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxinerama-dev \
            libxkbcommon-dev \
            libxrender-dev \
            libxrandr-dev

      - name: Read package version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          package_version="$(sed -nE 's/^[[:space:]]*\.version[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/p' build.zig.zon | head -n1)"
          if [[ -z "${package_version}" ]]; then
            echo "Failed to parse version from build.zig.zon" >&2
            exit 1
          fi
          echo "package_version=${package_version}" >> "${GITHUB_OUTPUT}"
          echo "release_tag=v${package_version}" >> "${GITHUB_OUTPUT}"

      - name: Build release artifact
        run: zig build package -Doptimize=ReleaseSafe --prefix dist -Drelease-version=${{ steps.version.outputs.package_version }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: waystream-linux-x86_64-${{ github.sha }}
          path: dist/*
          if-no-files-found: error

  version_gate:
    name: Detect version change
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: package
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
      previous_version: ${{ steps.detect.outputs.previous_version }}
      current_version: ${{ steps.detect.outputs.current_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect build.zig.zon version change
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          manifest_path="build.zig.zon"
          current_version="$(sed -nE 's/^[[:space:]]*\.version[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/p' "${manifest_path}" | head -n1)"
          previous_version=""
          changed="false"

          before_sha="${{ github.event.before }}"
          if [[ "${before_sha}" != "0000000000000000000000000000000000000000" ]]; then
            if git cat-file -e "${before_sha}:${manifest_path}" 2>/dev/null; then
              previous_version="$(git show "${before_sha}:${manifest_path}" | sed -nE 's/^[[:space:]]*\.version[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/p' | head -n1)"
            fi
          fi

          if [[ -n "${current_version}" && "${current_version}" != "${previous_version}" ]]; then
            changed="true"
          fi

          echo "previous_version=${previous_version}" >> "${GITHUB_OUTPUT}"
          echo "current_version=${current_version}" >> "${GITHUB_OUTPUT}"
          echo "changed=${changed}" >> "${GITHUB_OUTPUT}"

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [package, version_gate]
    if: github.event_name == 'push' && needs.version_gate.outputs.changed == 'true'
    permissions:
      contents: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: waystream-linux-x86_64-${{ github.sha }}
          path: dist

      - name: Ensure Linux ELF is executable
        shell: bash
        run: |
          set -euo pipefail
          chmod u+x dist/*-linux-x86_64-elf

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.package.outputs.release_tag }}
          name: ${{ needs.package.outputs.release_tag }}
          files: |
            dist/*-linux-x86_64-elf
            dist/SHA256SUMS.txt
          generate_release_notes: true
          overwrite_files: true

  test_release:
    name: Publish rolling test release
    runs-on: ubuntu-latest
    needs: package
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: waystream-linux-x86_64-${{ github.sha }}
          path: dist

      - name: Ensure Linux ELF is executable
        shell: bash
        run: |
          set -euo pipefail
          chmod u+x dist/*-linux-x86_64-elf

      - name: Move rolling test tag
        shell: bash
        run: |
          set -euo pipefail
          git tag -f test-main "${GITHUB_SHA}"
          git push --force origin refs/tags/test-main

      - name: Create or update rolling test release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: test-main
          name: test-main
          prerelease: true
          generate_release_notes: false
          overwrite_files: true
          body: |
            Rolling prerelease built from `main`.
            Commit: `${{ github.sha }}`
          files: |
            dist/*-linux-x86_64-elf
            dist/SHA256SUMS.txt
